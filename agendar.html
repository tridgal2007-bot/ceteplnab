<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agendamento de Laboratórios — Minha Agenda</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Jersey+15&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-a: #0b1225;
      --bg-b: #060f2b;
      --card: rgba(15, 23, 42, 0.6);
      --glass: rgba(255, 255, 255, 0.05);
      --muted: rgba(230, 238, 248, 0.75);
      --accent: #a7ff83;
      --accent-2: #66d9ff;
      --accent-glow: rgba(167, 255, 131, 0.3);
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      --radius: 16px;
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      font-size: 16px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
    }

    body {
      font-family: 'Jersey 15', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
      background: radial-gradient(circle at 10% 20%, rgba(102, 217, 255, 0.04), transparent 40%),
                  radial-gradient(circle at 90% 80%, rgba(167, 255, 131, 0.03), transparent 50%),
                  linear-gradient(145deg, var(--bg-a), var(--bg-b));
      color: #e6eef8;
      min-height: 100vh;
      padding: 24px;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      overflow-x: hidden;
    }

    .stage {
      width: min(1120px, 96%);
      display: flex;
      flex-direction: column;
      gap: 28px;
      align-items: center;
    }

    /* HEADER */
    header {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 18px 24px;
      border-radius: var(--radius);
      background: var(--card);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.04);
      box-shadow: var(--shadow), 0 0 0 1px rgba(255, 255, 255, 0.03);
      color: white;
      position: relative;
      overflow: hidden;
    }

    header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, transparent 60%, rgba(167, 255, 131, 0.05) 100%);
      z-index: -1;
    }

    header .title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    header h1 {
      margin: 0;
      font-size: 1.3rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      color: white;
    }

    .subtitle {
      width: 100%;
      text-align: center;
      color: var(--muted);
      font-size: 0.95rem;
      line-height: 1.4;
    }

    /* STATUS ROW */
    .status-row {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 16px;
      background: var(--glass);
      border-radius: var(--radius);
      border: 1px solid rgba(255, 255, 255, 0.04);
    }

    .remaining {
      font-weight: 600;
      color: white;
      font-size: 1rem;
    }

    .note {
      color: var(--muted);
      font-size: 0.9rem;
      text-align: right;
      flex: 1;
    }

    /* LABS CONTAINER */
    .lab-container {
      width: 100%;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      align-items: start;
    }

    .lab-card {
      background: var(--card);
      backdrop-filter: blur(12px);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow), 0 0 0 1px rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.04);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: var(--transition);
      min-height: 0;
      text-align: left;
    }

    .lab-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, transparent 60%, rgba(102, 217, 255, 0.03) 100%);
      z-index: -1;
    }

    .lab-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.5), 0 0 0 1px var(--accent-glow);
    }

    .lab-card.interdited {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.3);
      cursor: not-allowed;
      opacity: 0.7;
    }

    .lab-title {
      font-weight: 700;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
      font-size: 1.1rem;
      letter-spacing: 0.3px;
    }

    .interdict-btn {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--accent-glow);
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 0.85rem;
      cursor: pointer;
      opacity: 0;
      transition: var(--transition);
      font-weight: 600;
    }

    .lab-card:hover .interdict-btn {
      opacity: 1;
      background: var(--accent-glow);
      color: var(--accent);
    }

    .lab-card.interdited .interdict-btn {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
      border-color: rgba(16, 185, 129, 0.3);
      opacity: 1;
    }

    .interdiction-info {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .interdiction-info strong {
      color: white;
    }

    label.turno-label {
      display: block;
      margin-top: 12px;
      font-size: 0.95rem;
      color: var(--muted);
    }

    select.turno {
      margin-top: 8px;
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: var(--glass);
      color: white;
      font-size: 0.95rem;
      font-family: inherit;
      transition: var(--transition);
    }

    select.turno:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-glow);
    }

    select.turno:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* DAY GRID */
    .day-grid {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 12px 0 8px;
      flex-wrap: wrap;
    }

    .day-btn {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: var(--glass);
      cursor: pointer;
      font-size: 0.9rem;
      min-width: 80px;
      color: white;
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .day-btn:hover {
      background: var(--accent-glow);
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    .day-btn.disabled {
      opacity: 0.4;
      pointer-events: none;
      cursor: not-allowed;
    }

    .day-btn.selected {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border-color: var(--accent);
      box-shadow: 0 4px 12px rgba(167, 255, 131, 0.2);
      transform: translateY(-2px);
      color: #06202b;
    }

    .day-label {
      display: block;
      font-weight: 600;
      text-transform: capitalize;
    }

    .day-sub {
      display: block;
      color: var(--muted);
      font-size: 0.8rem;
      margin-top: 2px;
    }

    /* HORARIOS */
    .horarios {
      margin-top: 12px;
      text-align: left;
      border-radius: 8px;
      background: var(--glass);
      overflow: hidden;
      max-height: 0;
      padding: 0 12px;
      opacity: 0;
      transition: var(--transition);
      min-height: 0;
    }

    .horarios.open {
      max-height: 420px;
      padding: 12px;
      opacity: 1;
    }

    .horarios .item-label {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      user-select: none;
      transition: var(--transition);
      color: white;
      font-size: 0.95rem;
      background: transparent;
      border: 1px solid transparent;
    }

    .horarios .item-label:hover {
      background: var(--accent-glow);
      border-color: var(--accent);
    }

    .horarios .item-label.selected {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #06202b;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(167, 255, 131, 0.2);
    }

    .horarios input[type="checkbox"] {
      transform: scale(1.1);
      accent-color: var(--accent);
      transition: var(--transition);
    }

    .horarios input[type="checkbox"]:checked {
      transform: scale(1.3);
    }

    .horarios .disabled {
      color: var(--muted);
      opacity: 0.6;
      pointer-events: none;
    }

    .horarios input[type="checkbox"]:disabled {
      cursor: not-allowed;
    }

    .btn {
      margin-top: auto;
      padding: 12px 16px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #06202b;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 0.3px;
      font-family: inherit;
      transition: var(--transition);
      width: 100%;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(167, 255, 131, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      background: var(--glass);
      color: var(--muted);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* AGENDA LIST */
    .agenda-list {
      width: 100%;
      background: var(--card);
      backdrop-filter: blur(12px);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow), 0 0 0 1px rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.04);
      overflow: hidden;
    }

    .agenda-list table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
      color: white;
    }

    .agenda-list th,
    .agenda-list td {
      text-align: left;
      padding: 12px 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .agenda-list th {
      color: var(--muted);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
    }

    .small-btn {
      background: var(--glass);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: var(--transition);
    }

    .small-btn:hover {
      background: var(--accent-glow);
      border-color: var(--accent);
      color: var(--accent);
    }

    .small-btn.del {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.3);
      color: white;
    }

    .small-btn.del:hover {
      background: rgba(239, 68, 68, 0.4);
      border-color: rgba(239, 68, 68, 0.5);
      color: white;
    }

    /* RESET BOX */
    .reset-box {
      width: 100%;
      background: var(--card);
      backdrop-filter: blur(12px);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow), 0 0 0 1px rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.04);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .reset-box::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, transparent 60%, rgba(167, 255, 131, 0.05) 100%);
      z-index: -1;
    }

    .reset-box.hidden {
      display: none !important;
    }

    .reset-box .title {
      font-size: 1.1rem;
      font-weight: 700;
      color: white;
    }

    .reset-box .message {
      color: var(--muted);
      font-size: 0.95rem;
    }

    .reset-box .countdown {
      margin-top: 6px;
      font-size: 1.75rem;
      font-weight: 800;
      letter-spacing: 1px;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .reset-box .sub {
      color: var(--muted);
      font-size: 0.9rem;
    }

    /* BADGE */
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #06202b;
      font-weight: 700;
      font-size: 0.8rem;
      margin-left: 8px;
    }

    /* MODAL */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
    }

    .modal-content {
      background: var(--card);
      backdrop-filter: blur(12px);
      margin: 12% auto;
      padding: 24px;
      border-radius: var(--radius);
      width: 90%;
      max-width: 560px;
      box-shadow: var(--shadow), 0 0 0 1px rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.04);
      color: white;
      position: relative;
      overflow: hidden;
    }

    .modal-content::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, transparent 60%, rgba(102, 217, 255, 0.03) 100%);
      z-index: -1;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .modal-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: white;
    }

    .close {
      color: var(--muted);
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: var(--transition);
    }

    .close:hover {
      color: white;
    }

    .modal-body {
      margin-bottom: 20px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .btn-modal {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-family: inherit;
      transition: var(--transition);
    }

    .btn-cancel {
      background: var(--glass);
      color: var(--muted);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn-cancel:hover {
      background: rgba(255, 255, 255, 0.05);
      color: white;
    }

    .btn-confirm,
    .btn-remove {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #06202b;
    }

    .btn-confirm:hover,
    .btn-remove:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(167, 255, 131, 0.3);
    }

    .btn-remove {
      background: rgba(239, 68, 68, 0.2);
      color: white;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .btn-remove:hover {
      background: rgba(239, 68, 68, 0.4);
    }

    textarea,
    input[type="datetime-local"] {
      width: 100%;
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      background: var(--glass);
      color: white;
      font-family: inherit;
      resize: vertical;
      font-size: 0.95rem;
      transition: var(--transition);
    }

    textarea:focus,
    input[type="datetime-local"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-glow);
    }

    .interdiction-info {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      border-radius: 8px;
      padding: 12px;
      margin-top: 10px;
      text-align: left;
      color: var(--muted);
    }

    .interdiction-info strong {
      color: white;
    }

    /* RESPONSIVE */
    @media (max-width: 880px) {
      body { padding: 16px; }
      .stage { gap: 20px; }
      header { padding: 16px 20px; }
      .status-row { padding: 12px; flex-direction: column; align-items: stretch; gap: 8px; text-align: center; }
      .note { text-align: center; }
      .lab-container {
        grid-template-columns: 1fr;
      }
      .agenda-list { padding: 16px; }
      .modal-content { margin: 20% auto; padding: 16px; width: 95%; }
    }

    @media (max-width: 480px) {
      .lab-container {
        display: flex;
        flex-direction: row-reverse;
        overflow-x: auto;
        gap: 16px;
        padding-bottom: 8px;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
      }
      .lab-card {
        flex: 0 0 280px;
        scroll-snap-align: start;
      }
      .day-grid { gap: 8px; justify-content: flex-start; }
      .day-btn { min-width: 72px; padding: 8px 10px; font-size: 0.85rem; }
      .reset-box .countdown { font-size: 1.25rem; }
      .modal-content { margin: 25% auto; padding: 12px; }
    }

    /* FOCUS STYLES FOR ACCESSIBILITY */
    .btn:focus-visible,
    .day-btn:focus-visible,
    .item-label:focus-within,
    .interdict-btn:focus-visible,
    .small-btn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <div class="stage">
    <header>
      <div class="title">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M12 2L2 7v10c0 3.31 2.69 6 6 6s6-2.69 6-6V7l-10-5zM13 17v-5h-2v5h2z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <h1>Agendamento de Laboratórios</h1>
      </div>
    </header>

    <div class="subtitle">Cada agendamento pode conter até <strong>2 horários</strong>. Limite: <strong>4 agendamentos por semana</strong>.</div>

    <div class="status-row">
      <div class="remaining" id="restantes">Agendamentos restantes: —</div>
      <div class="note">Horários da manhã começam em <strong>07:00</strong>, cada bloco com 45 minutos.</div>
    </div>

    <div id="labs" class="lab-container"></div>

    <div class="agenda-list" id="agendaList" aria-live="polite"></div>

    <div id="resetBox" class="reset-box hidden" role="status" aria-live="polite">
      <div class="title" id="resetTitle">Fim do fim de semana — reabertura às 18:00 de domingo</div>
      <div class="message" id="resetMessage">O contador mostra o tempo restante até domingo às <strong>18:00</strong>.</div>
      <div class="countdown" id="resetCountdown">--:--:--</div>
      <div class="sub" id="resetSub">Tempo restante até o fim do fim de semana</div>
    </div>

    <!-- Modal for interdiction -->
    <div id="interdictionModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title" id="modalTitle">Interromper uso do laboratório</div>
          <span class="close">&times;</span>
        </div>
        <div class="modal-body">
          <p id="modalPrompt">Informe o motivo da interdição do laboratório:</p>
          <textarea id="interdictionReason" placeholder="Descreva o motivo da interdição..."></textarea>
          <p style="margin-top:8px;margin-bottom:6px;font-size:0.95rem;color:var(--muted);">Data fim (opcional) — se preenchida, interdição expira nessa data/hora</p>
          <input id="interdictionEnd" type="datetime-local" />
          <div id="interdictionInfo" class="interdiction-info" style="display: none;"></div>
        </div>
        <div class="modal-footer">
          <button class="btn-modal btn-cancel" id="cancelInterdiction">Cancelar</button>
          <button class="btn-modal btn-confirm" id="confirmInterdiction">Confirmar Interdição</button>
          <button class="btn-modal btn-remove" id="removeInterdiction" style="display: none;">Remover Interdição</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://zszcwubydhgoyhxbxfro.supabase.co"; // já no seu código
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzemN3dWJ5ZGhnb3loeGJ4ZnJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MDk5MDMsImV4cCI6MjA3NTM4NTkwM30.ryioOoPAZnZzGdcTxIjfUcSlYUUqa7arA4qlUukyV7M";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    function generateAgendamentoId() { return 'agendamento_' + Date.now() + '_' + Math.random().toString(36).substr(2,5); }

    const LABS = ["Lab 1", "Lab 2", "Lab 3", "Lab 4", "Lab Raul"];
    const HORARIOS_MANHA = [
      "1º horário (07:00 - 07:45)",
      "2º horário (07:45 - 08:30)",
      "3º horário (08:30 - 09:15)",
      "4º horário (09:15 - 10:00)",
      "Intervalo (10:00 - 10:20)",
      "5º horário (10:20 - 11:05)",
      "6º horário (11:05 - 11:50)"
    ];
    const HORARIOS_TARDE = [
      "1º horário (13:00 - 13:45)",
      "2º horário (13:45 - 14:30)",
      "3º horário (14:30 - 15:15)",
      "4º horário (15:15 - 16:00)",
      "Intervalo (16:00 - 16:20)",
      "5º horário (16:20 - 17:05)",
      "6º horário (17:05 - 17:50)"
    ];
    const HORARIOS_NOITE = [
      "1º horário (18:00 - 18:45)",
      "2º horário (18:45 - 19:30)",
      "3º horário (19:30 - 20:15)",
      "4º horário (20:15 - 21:00)",
      "5º horário (21:00 - 21:45)",
      "6º horário (21:45 - 22:00)"
    ];

    const STORAGE_KEY = "agendamentos_v3";
    const NOTIFIED_KEY = "agendamentos_notificados_v3";

    function slugify(text){ return text.toString().toLowerCase().replace(/\s+/g,'-').replace(/[^\w-]+/g,'').replace(/--+/g,'-'); }
    function getWeekNumber(date){ const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate())); const dayNum = d.getUTCDay() || 7; d.setUTCDate(d.getUTCDate() + 4 - dayNum); const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil(((d - yearStart)/86400000 + 1)/7); }

    const hoje = new Date();
    const semanaAtual = `${hoje.getFullYear()}-W${getWeekNumber(hoje)}`;

    function loadData(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) {
          const init = { semana: semanaAtual, quantidade: 0, registros: [] };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(init));
          return init;
        }
        const obj = JSON.parse(raw);
        if (!obj.semana || obj.semana !== semanaAtual){
          const init = { semana: semanaAtual, quantidade: 0, registros: [] };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(init));
          return init;
        }
        return obj;
      }catch(e){
        const init = { semana: semanaAtual, quantidade: 0, registros: [] };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(init));
        return init;
      }
    }
    function saveData(d){ localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }

    function loadNotified(){ try{ return JSON.parse(localStorage.getItem(NOTIFIED_KEY)) || {}; }catch{return {}} }
    function saveNotified(obj){ localStorage.setItem(NOTIFIED_KEY, JSON.stringify(obj)); }

    let dados = loadData();

    function getLocalUser(){ try{ return JSON.parse(localStorage.getItem('userData')) || null; } catch { return null; } }
    let userClasse = null;
    let userEmail = null;

    function getWeekDays(includeWeekend = false){
      const today = new Date();
      const day = today.getDay();
      const monday = new Date(today);
      monday.setDate(today.getDate() - (day === 0 ? 6 : day - 1));
      monday.setHours(0,0,0,0);
      const days = [];
      const count = includeWeekend ? 7 : 5;
      for(let i=0;i<count;i++){
        const d = new Date(monday);
        d.setDate(monday.getDate() + i);
        days.push(d);
      }
      return days;
    }
    function formatDayLong(d){ return d.toLocaleDateString('pt-BR', { weekday:'long', day:'2-digit', month:'2-digit' }); }
    function isSameDay(a,b){ if(!a||!b) return false; return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
    function parseRangeFromLabel(label){ const m = label.match(/(\d{2}:\d{2})\s*-\s*(\d{2}:\d{2})/); if(!m) return null; return { start: m[1], end: m[2] }; }
    function horarioPassou(label, diaEscolhido){ if(!diaEscolhido) return false; const agora = new Date(); if(!isSameDay(agora, diaEscolhido)) return false; const range = parseRangeFromLabel(label); if(!range) return false; const [sh, sm] = range.start.split(':').map(Number); const [eh, em] = range.end.split(':').map(Number); const inicio = new Date(diaEscolhido); inicio.setHours(sh, sm, 0, 0); const fim = new Date(diaEscolhido); fim.setHours(eh, em, 0, 0); return fim <= agora; }

    function getWeekRangeFor(date = new Date()){
      const d = new Date(date);
      const day = d.getDay();
      const monday = new Date(d);
      monday.setDate(d.getDate() - (day === 0 ? 6 : day - 1));
      monday.setHours(0,0,0,0);
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      sunday.setHours(23,59,59,999);
      return { start: monday.toISOString(), end: sunday.toISOString() };
    }

    // Supabase: agendamentos table functions (mantidas iguais)
    async function fetchUserClasseFromDb(email){
      if(!email) return null;
      try{
        const { data, error } = await supabase
          .from('dadoscetep')
          .select('classe')
          .eq('email', email)
          .maybeSingle();
        if(error) return null;
        return data?.classe || null;
      }catch(e){
        return null;
      }
    }
    async function countWeeklyAgendasFor(email, date){
      if(!email) return 0;
      const { start, end } = getWeekRangeFor(date);
      try{
        const { count, error } = await supabase
          .from('agendamentos')
          .select('*', { count: 'exact' })
          .eq('user_email', email)
          .gte('dia', start)
          .lte('dia', end);
        if(error) return 0;
        return count || 0;
      }catch(e){
        return 0;
      }
    }
    async function insertAgendamentoToDb(payload){
      try{
        const agendamentoId = generateAgendamentoId();
        const { data, error } = await supabase
          .from('agendamentos')
          .insert([{
            id: agendamentoId,
            user_email: payload.email,
            lab_nome: payload.lab_nome,
            dia: payload.dia,
            turno: payload.turno,
            horario: payload.horario
          }])
          .select('id')
          .maybeSingle();
        if(error){
          console.error('Erro ao inserir agendamento:', error);
          return { error };
        }
        return { data };
      }catch(e){
        console.error('Exceção ao inserir agendamento:', e);
        return { error: e };
      }
    }
    async function deleteAgendamentoFromDb(dbId){
      if(!dbId) return { error: 'ID ausente' };
      try{
        const { error } = await supabase
          .from('agendamentos')
          .delete()
          .eq('id', dbId);
        return { error };
      }catch(e){
        return { error: e };
      }
    }

    // ====== NOVO: FUNÇÕES PARA SALVAR/REMOVER/OBTER 'parado' ======
    // tabela 'parado' com colunas: user_email, lab_nome, motivo, data_fim
    async function fetchParadoActive() {
      // busca tudo e filtra no cliente (robusto e simples)
      try {
        const { data, error } = await supabase
          .from('parado')
          .select('*');
        if (error) {
          console.error('Erro ao buscar tabela parado:', error);
          return {};
        }
        const now = new Date();
        const map = {};
        (data || []).forEach(row => {
          // row.data_fim pode ser null ou uma string ISO
          const df = row.data_fim ? new Date(row.data_fim) : null;
          if (!df || df > now) {
            // interdição vigente
            map[row.lab_nome] = {
              user_email: row.user_email || null,
              motivo: row.motivo || '',
              data_fim: row.data_fim || null,
              raw: row
            };
          }
        });
        return map;
      } catch (e) {
        console.error('Exceção em fetchParadoActive:', e);
        return {};
      }
    }

    async function createParado(labName, motivo, dataFimISO) {
      // dataFimISO pode ser null
      try {
        const payload = {
          user_email: userEmail || null,
          lab_nome: labName,
          motivo: motivo || null,
          data_fim: dataFimISO || null
        };
        const { data, error } = await supabase
          .from('parado')
          .insert([payload])
          .select();
        if (error) {
          console.error('Erro ao inserir em parado:', error);
          return { error };
        }
        return { data };
      } catch (e) {
        console.error('Exceção createParado:', e);
        return { error: e };
      }
    }

    async function deleteParadoByLab(labName) {
      try {
        const { error } = await supabase
          .from('parado')
          .delete()
          .eq('lab_nome', labName);
        if (error) {
          console.error('Erro ao deletar interdição em parado:', error);
          return { error };
        }
        return { success: true };
      } catch (e) {
        console.error('Exceção deleteParadoByLab:', e);
        return { error: e };
      }
    }

    // ====== RESTO DO CÓDIGO (UI) ajustado para usar fetchParadoActive/createParado/deleteParadoByLab ======
    const labsContainer = document.getElementById("labs");
    const restantesEl = document.getElementById("restantes");
    const agendaListEl = document.getElementById("agendaList");
    const modal = document.getElementById("interdictionModal");
    const modalTitle = document.getElementById("modalTitle");
    const interdictionReason = document.getElementById("interdictionReason");
    const interdictionInfo = document.getElementById("interdictionInfo");
    const cancelInterdiction = document.getElementById("cancelInterdiction");
    const confirmInterdiction = document.getElementById("confirmInterdiction");
    const removeInterdiction = document.getElementById("removeInterdiction");
    const closeBtn = document.querySelector(".close");
    const interdictionEnd = document.getElementById("interdictionEnd");
    const modalPrompt = document.getElementById("modalPrompt");

    let currentLabForInterdiction = null;
    let interdictions = {}; // interdictions current map from fetchParadoActive

    async function buildCards(){
      interdictions = await fetchParadoActive();

      labsContainer.innerHTML = "";
      const includeWeekend = (userClasse === 'Direção');
      const dias = getWeekDays(includeWeekend);
      LABS.forEach(labName => {
        const id = slugify(labName);
        const card = document.createElement("div");
        card.className = "lab-card";
        card.id = `card-${id}`;

        const isInterdicted = !!interdictions[labName];
        if (isInterdicted) card.classList.add("interdited");

        const dayButtonsHtml = dias.map((d, idx) => {
          return `<button type="button" class="day-btn" data-date="${d.toISOString()}" data-idx="${idx}"><span class="day-label">${d.toLocaleDateString('pt-BR',{weekday:'short'}).replace('.', '')}</span><span class="day-sub">${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}</span></button>`;
        }).join("");

        card.innerHTML = `
          <div class="lab-title">
            <span>${labName}</span>
            ${userClasse === 'Direção' ? `<button class="interdict-btn">${isInterdicted ? 'Remover Interdição' : 'Interromper uso'}</button>` : ''}
          </div>
          ${isInterdicted ? `
            <div class="interdiction-info">
              <p><strong>Laboratório interditado pela Direção</strong></p>
              <p>${interdictions[labName].motivo || "Motivo não informado"}</p>
              <p>Expira em: ${interdictions[labName].data_fim ? new Date(interdictions[labName].data_fim).toLocaleString('pt-BR') : 'Indefinido'}</p>
            </div>
          ` : ''}
          <div class="day-grid" id="days-${id}" aria-hidden="false">${dayButtonsHtml}</div>
          <label class="turno-label" for="turno-${id}">Turno</label>
          <select id="turno-${id}" class="turno" data-lab="${id}" ${isInterdicted ? 'disabled' : ''}>
            <option value="">-- selecione --</option>
            <option value="Manhã">Manhã</option>
            <option value="Tarde">Tarde</option>
            <option value="Noite">Noite</option>
          </select>
          <div id="horarios-${id}" class="horarios" aria-live="polite"></div>
          <button class="btn" data-lab="${id}" ${isInterdicted ? 'disabled' : ''}>Agendar</button>
        `;
        labsContainer.appendChild(card);

        // interdiction button event (Direção)
        if (userClasse === 'Direção') {
          const interdictBtn = card.querySelector('.interdict-btn');
          interdictBtn.addEventListener('click', () => {
            currentLabForInterdiction = labName;
            if (isInterdicted) {
              // show remove modal view
              modalTitle.textContent = `Remover interdição do ${labName}`;
              interdictionReason.style.display = 'none';
              interdictionEnd.style.display = 'none';
              interdictionInfo.style.display = 'block';
              interdictionInfo.innerHTML = `
                <p><strong>Motivo da interdição:</strong></p>
                <p>${interdictions[labName].motivo || "Motivo não informado"}</p>
                <p><strong>Expira em:</strong> ${interdictions[labName].data_fim ? new Date(interdictions[labName].data_fim).toLocaleString('pt-BR') : 'Indefinido'}</p>
              `;
              confirmInterdiction.style.display = 'none';
              removeInterdiction.style.display = 'inline-block';
              modalPrompt.style.display = 'none';
            } else {
              // show create interdiction view
              modalTitle.textContent = `Interromper uso do ${labName}`;
              interdictionReason.style.display = 'block';
              interdictionEnd.style.display = 'block';
              interdictionInfo.style.display = 'none';
              interdictionReason.value = '';
              interdictionEnd.value = '';
              confirmInterdiction.style.display = 'inline-block';
              removeInterdiction.style.display = 'none';
              modalPrompt.style.display = 'block';
            }
            modal.style.display = 'block';
          });
        }

        // day / horarios / agendar events only if not interdicted
        if (!isInterdicted) {
          const dayGrid = card.querySelector(`#days-${id}`);
          dayGrid.querySelectorAll('.day-btn').forEach(btn=>{
            const dateISO = btn.dataset.date;
            const dateObj = new Date(dateISO);
            const todayStart = new Date(); todayStart.setHours(0,0,0,0);
            if (dateObj < todayStart) { btn.classList.add('disabled'); btn.setAttribute('aria-disabled','true'); }
            btn.addEventListener('click', ()=> {
              dayGrid.querySelectorAll('.day-btn').forEach(b=>b.classList.remove('selected'));
              btn.classList.add('selected');
              const selTurno = document.getElementById(`turno-${id}`);
              if (selTurno && selTurno.value) showHorarios(id, labName);
              else { const target = document.getElementById(`horarios-${id}`); target.classList.remove('open'); target.innerHTML=''; }
            });
          });

          const sel = card.querySelector(`#turno-${id}`);
          sel.addEventListener("change", ()=> showHorarios(id, labName));
          const btnAg = card.querySelector(".btn");
          btnAg.addEventListener("click", ()=> confirmarAgendamento(id, labName));
        }
      });
    }

    function populateHorariosFragment(turno, diaEscolhido, id){
      const frag = document.createDocumentFragment();
      let horarios = [];
      let prefix = '';
      if (turno === "Manhã") {
        horarios = HORARIOS_MANHA;
        prefix = 'm';
      } else if (turno === "Tarde") {
        horarios = HORARIOS_TARDE;
        prefix = 't';
      } else if (turno === "Noite") {
        horarios = HORARIOS_NOITE;
        prefix = 'n';
      }
      let anyEnabled = false;
      horarios.forEach((h, idx) => {
        const checkboxId = `chk-${prefix}-${id}-${idx}-${Math.random().toString(36).slice(2,7)}`;
        const label = document.createElement("label");
        label.className = "item-label";
        label.htmlFor = checkboxId;
        label.innerHTML = `<input type="checkbox" id="${checkboxId}" value="${h}"> ${h}`;
        const cb = label.querySelector("input[type=checkbox]");
        if (h.includes("Intervalo")) {
          cb.disabled = true;
          label.classList.add("disabled");
          cb.title = "Intervalo não agendável";
        } else if (horarioPassou(h, diaEscolhido)) {
          cb.disabled = true;
          label.classList.add("disabled");
          cb.title = "Esse horário já passou hoje";
        } else {
          anyEnabled = true;
          cb.addEventListener("change", ()=> { label.classList.toggle("selected", cb.checked); const containerId = label.closest(".horarios").id.replace("horarios-",""); limitarSelecao(containerId); });
        }
        frag.appendChild(label);
      });
      if (!anyEnabled && horarios.length > 0){ const p = document.createElement("div"); p.style.padding="8px 6px"; p.style.color="#ef4444"; p.style.fontWeight="600"; p.textContent=`Todos os horários do turno ${turno.toLowerCase()} já passaram hoje.`; frag.appendChild(p); }
      return frag;
    }

    function showHorarios(id, labName){
      const turnoEl = document.getElementById(`turno-${id}`);
      if(!turnoEl) return;
      const turno = turnoEl.value;
      const target = document.getElementById(`horarios-${id}`);
      const dayGrid = document.getElementById(`days-${id}`);
      const selectedDayBtn = dayGrid ? dayGrid.querySelector('.day-btn.selected') : null;
      if(!turno || !selectedDayBtn){ document.querySelectorAll('.horarios.open').forEach(hEl => { if (hEl !== target) hEl.classList.remove('open'); }); target.classList.remove('open'); target.innerHTML = ''; return; }

      document.querySelectorAll('.horarios.open').forEach(hEl => { if (hEl !== target) hEl.classList.remove('open'); });

      const diaEscolhido = new Date(selectedDayBtn.dataset.date);
      const openClass = "open";
      const populate = () => {
        target.innerHTML = "";
        const frag = populateHorariosFragment(turno, diaEscolhido, id);
        target.appendChild(frag);
        requestAnimationFrame(()=> target.classList.add(openClass));
        limitarSelecao(id);
      };

      if (target.classList.contains(openClass)){ target.classList.remove(openClass); setTimeout(populate, 260); } else { populate(); }
    }

    function limitarSelecao(id){
      const container = document.getElementById(`horarios-${id}`);
      if(!container) return;
      const checkboxes = Array.from(container.querySelectorAll('input[type="checkbox"]'));
      const checked = checkboxes.filter(c=>c.checked);
      if(checked.length >= 2){
        checkboxes.forEach(cb=>{ if(!cb.checked){ cb.disabled = true; const lab = cb.closest("label"); if(lab) lab.classList.add("disabled"); }});
      }else{
        checkboxes.forEach(cb=>{
          const labelText = cb.value || "";
          const lab = cb.closest("label");
          if (labelText.includes("Intervalo")) {
            cb.disabled = true;
            if(lab) lab.classList.add("disabled");
          } else if (labelText && horarioPassou(labelText, getSelectedDayForCard(id))) {
            cb.disabled = true;
            if(lab) lab.classList.add("disabled");
            if(lab) lab.classList.remove("selected");
          } else {
            cb.disabled = false;
            if(lab) lab.classList.remove("disabled");
            if(lab) lab.classList.toggle("selected", cb.checked);
          }
        });
      }
    }

    function getSelectedDayForCard(id){
      const dayGrid = document.getElementById(`days-${id}`);
      if(!dayGrid) return null;
      const sel = dayGrid.querySelector('.day-btn.selected');
      return sel ? new Date(sel.dataset.date) : null;
    }

    async function confirmarAgendamento(id, labName){
      // re-check interdição no servidor antes de permitir
      const current = await fetchParadoActive();
      if (current[labName]) {
        alert("Este laboratório está interditado pela Direção e não pode ser agendado.");
        await buildCards();
        return;
      }

      const turno = document.getElementById(`turno-${id}`).value;
      const day = getSelectedDayForCard(id);
      if(!day){ alert("Selecione um dia antes de agendar."); return; }
      if(!turno){ alert("Selecione um turno antes de agendar."); return; }

      const container = document.getElementById(`horarios-${id}`);
      let horariosSelecionados = [];
      if(container){
        horariosSelecionados = Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(i=>i.value);
      }

      if((turno === "Manhã" || turno === "Tarde") && horariosSelecionados.length === 0){ alert("Selecione pelo menos um horário para esse turno."); return; }
      if(horariosSelecionados.length > 2){ alert("Você só pode escolher até 2 horários."); return; }

      if ((turno === "Manhã" || turno === "Tarde") && horariosSelecionados.length){
        const validos = horariosSelecionados.filter(h => !horarioPassou(h, day));
        if (validos.length === 0){
          alert("⚠️ Os horários selecionados já passaram. Escolha horários futuros ou outro dia.");
          showHorarios(id, labName);
          return;
        }
        horariosSelecionados = validos;
      }

      const localUser = getLocalUser();
      userEmail = localUser ? (localUser.email || null) : null;
      if(userClasse !== 'Direção'){
        dados = loadData();
        if(dados.quantidade >= 4){
          alert("Você já atingiu o limite de 4 agendamentos nesta semana.");
          return;
        }
        if(userEmail){
          const serverCount = await countWeeklyAgendasFor(userEmail, day);
          const localCountForWeek = dados.registros.filter(r=>{
            const rDay = new Date(r.dia);
            return r.email === userEmail && (new Date(r.dia) >= new Date(getWeekRangeFor(day).start) && new Date(r.dia) <= new Date(getWeekRangeFor(day).end));
          }).length;
          const totalCount = serverCount + localCountForWeek;
          if(totalCount >= 4){
            alert("Você já atingiu o limite de 4 agendamentos nesta semana (servidor + local).");
            return;
          }
        }
      }

      dados = loadData();
      const conflitantes = dados.registros.filter(r=>{
        if(r.lab !== labName) return false;
        const rDay = new Date(r.dia);
        if(!isSameDay(rDay, day)) return false;
        return r.horarios.some(h => horariosSelecionados.includes(h));
      });
      if(conflitantes.length){
        alert("Já existe um agendamento local para este laboratório no mesmo dia/horário. Escolha outro horário ou dia.");
        return;
      }

      const payload = {
        email: userEmail,
        lab_nome: labName,
        horario: horariosSelecionados,
        dia: day.toISOString(),
        turno: turno
      };

      let dbId = null;
      if(userEmail){
        const res = await insertAgendamentoToDb(payload);
        if(res.error){
          console.warn('Erro ao salvar no servidor — usando fallback local.', res.error);
          alert('⚠️ Agendamento salvo localmente. Erro no servidor.');
        } else if(res.data){
          dbId = res.data.id;
        }
      }

      const registro = {
        id: `${id}-${Date.now()}`,
        db_id: dbId,
        lab: labName,
        turno,
        horarios: horariosSelecionados,
        dia: day.toISOString(),
        email: userEmail
      };
      dados.registros.push(registro);
      dados.quantidade = (dados.quantidade || 0) + 1;
      saveData(dados);

      checkAgendamentosStatus();
      alert(`✅ Agendado: ${labName}\nDia: ${formatDayLong(day)}\nTurno: ${turno}\n${horariosSelecionados.length ? "Horários: "+horariosSelecionados.join(", ") : ""}`);
      renderRemaining();
      renderAgenda();
      limparCard(id);
    }

    function renderRemaining(){
      dados = loadData();
      if(userClasse === 'Direção'){
        restantesEl.textContent = `Agendamentos restantes: ilimitado (Direção)`;
      } else {
        const rem = Math.max(0, 4 - (dados.quantidade||0));
        restantesEl.textContent = `Agendamentos restantes: ${rem}`;
      }
    }

    function renderAgenda(){
      dados = loadData();
      if(!dados.registros || dados.registros.length === 0){
        agendaListEl.innerHTML = `<div style="color:var(--muted); padding:8px">Nenhum agendamento nesta semana.</div>`;
        return;
      }
      let html = `<table aria-label="Agendamentos">
        <thead><tr><th>Laboratório</th><th>Dia</th><th>Turno</th><th>Horários</th><th>Ações</th></tr></thead><tbody>`;
      dados.registros.forEach((r, idx)=>{
        const diaFmt = formatDayLong(new Date(r.dia));
        const happening = isRegistroHappeningNow(r);
        html += `<tr>
          <td>${escapeHtml(r.lab)} ${happening ? '<span class="badge">Acontecendo agora</span>' : ''}</td>
          <td>${escapeHtml(diaFmt)}</td>
          <td>${escapeHtml(r.turno)}</td>
          <td>${escapeHtml((r.horarios && r.horarios.length) ? r.horarios.join(", ") : "-")}</td>
          <td><button class="small-btn del" data-idx="${idx}">Excluir</button></td>
        </tr>`;
      });
      html += `</tbody></table>`;
      agendaListEl.innerHTML = html;

      agendaListEl.querySelectorAll("button.del").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const idx = Number(btn.dataset.idx);
          if (!Number.isFinite(idx)) return;
          if(!confirm("Remover esse agendamento?")) return;

          const registro = dados.registros[idx];
          if(registro && registro.db_id){
            const { error } = await deleteAgendamentoFromDb(registro.db_id);
            if(error){
              console.warn('Falha ao remover do servidor:', error);
            }
          }
          dados.registros.splice(idx,1);
          dados.quantidade = Math.max(0, (dados.quantidade||0) - 1);
          saveData(dados);
          renderRemaining();
          renderAgenda();
        });
      });
    }

    function limparCard(id){
      const sel = document.getElementById(`turno-${id}`);
      if(sel) sel.value = "";
      const dayGrid = document.getElementById(`days-${id}`);
      if(dayGrid) dayGrid.querySelectorAll('.day-btn').forEach(b=>b.classList.remove('selected'));
      const container = document.getElementById(`horarios-${id}`);
      if(!container) return;
      container.classList.remove("open");
      setTimeout(()=> container.innerHTML = "", 300);
    }

    function escapeHtml(str){
      if(!str && str !== 0) return "";
      return String(str).replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s]));
    }

    function isRegistroHappeningNow(registro){
      const now = new Date();
      const day = new Date(registro.dia);
      for(const label of (registro.horarios||[])){
        const range = parseRangeFromLabel(label);
        if(!range) continue;
        const [sh, sm] = range.start.split(':').map(Number);
        const [eh, em] = range.end.split(':').map(Number);
        const inicio = new Date(day); inicio.setHours(sh, sm, 0, 0);
        const fim = new Date(day); fim.setHours(eh, em, 0, 0);
        if(now >= inicio && now < fim) return true;
      }
      return false;
    }

    async function checkAgendamentosStatus(){
      dados = loadData();
      const now = new Date();
      const notified = loadNotified();
      let changed = false;
      const remaining = [];
      let removedCount = 0;

      for(const registro of dados.registros){
        const day = new Date(registro.dia);
        let anyOngoing = false;
        let allPast = true;

        for(const label of (registro.horarios||[])){
          const range = parseRangeFromLabel(label);
          if(!range) continue;
          const [sh, sm] = range.start.split(':').map(Number);
          const [eh, em] = range.end.split(':').map(Number);
          const inicio = new Date(day); inicio.setHours(sh, sm, 0, 0);
          const fim = new Date(day); fim.setHours(eh, em, 0, 0);

          if(now < fim) allPast = false;
          if(now >= inicio && now < fim){
            anyOngoing = true;
            const key = `${registro.id}::${label}`;
            if(!notified[key]){
              showNotification(`Agendamento: ${registro.lab}`, `${formatDayLong(day)} — ${label}`);
              notified[key] = true;
              saveNotified(notified);
            }
          }
        }

        if(allPast){
          removedCount += 1;
          changed = true;
          if(registro.db_id){
            deleteAgendamentoFromDb(registro.db_id).then(res=>{
              if(res && res.error) console.warn('Erro ao apagar do servidor após expirar:', res.error);
            }).catch(e=>console.warn('Erro ao apagar do servidor:', e));
          }
        } else {
          registro._acontecendo = anyOngoing;
          remaining.push(registro);
        }
      }

      if(changed){
        dados.registros = remaining;
        dados.quantidade = Math.max(0, (dados.quantidade || 0) - removedCount);
        saveData(dados);
        renderRemaining();
        renderAgenda();
      } else {
        renderAgenda();
      }
    }

    function showNotification(title, body){
      if(!('Notification' in window)){
        alert(`${title}\n${body}`);
        return;
      }
      if(Notification.permission === 'granted'){
        try{ new Notification(title, { body }); }catch(e){ console.warn('Notificação falhou:', e); }
      } else if(Notification.permission !== 'denied'){
        Notification.requestPermission().then(perm => {
          if(perm === 'granted'){
            try{ new Notification(title, { body }); }catch(e){ console.warn('Notificação falhou:', e); }
          }
        });
      }
    }

    // Interdiction UI actions using novo CRUD para tabela 'parado'
    async function interdictLab(labName, motivo, dataFimISO) {
      const res = await createParado(labName, motivo, dataFimISO);
      if (res.error) {
        alert('Erro ao interditar laboratório. Tente novamente.');
        return;
      }
      await buildCards();
      modal.style.display = 'none';
      alert(`Laboratório ${labName} interditado com sucesso!`);
    }

    async function removeInterdictionForLab(labName) {
      const res = await deleteParadoByLab(labName);
      if (res.error) {
        alert('Erro ao remover interdição. Tente novamente.');
        return;
      }
      await buildCards();
      modal.style.display = 'none';
      alert(`Interdição removida do laboratório ${labName}!`);
    }

    // Modal handlers
    cancelInterdiction.addEventListener('click', () => { modal.style.display = 'none'; });
    confirmInterdiction.addEventListener('click', () => {
      const motivo = interdictionReason.value.trim();
      const dataFimVal = interdictionEnd.value ? new Date(interdictionEnd.value).toISOString() : null;
      if (!motivo) { alert("Por favor, informe o motivo da interdição."); return; }
      interdictLab(currentLabForInterdiction, motivo, dataFimVal);
    });
    removeInterdiction.addEventListener('click', () => {
      if (confirm(`Tem certeza que deseja remover a interdição do laboratório ${currentLabForInterdiction}?`)) {
        removeInterdictionForLab(currentLabForInterdiction);
      }
    });
    closeBtn.addEventListener('click', () => { modal.style.display = 'none'; });
    window.addEventListener('click', (event) => { if (event.target === modal) modal.style.display = 'none'; });

    async function init(){
      const localUser = getLocalUser();
      userEmail = localUser ? (localUser.email || null) : null;
      if(userEmail){
        const fetched = await fetchUserClasseFromDb(userEmail);
        userClasse = fetched || null;
      }
      if(!userClasse && localUser && localUser.classe) userClasse = localUser.classe;

      await buildCards();
      renderRemaining();
      renderAgenda();

      if('Notification' in window && Notification.permission === 'default'){ try{ Notification.requestPermission(); }catch(e){} }

      checkAgendamentosStatus();
      setInterval(checkAgendamentosStatus, 1000);

      // refresh interdições every 30s
      setInterval(async () => { if (document.visibilityState === 'visible') await buildCards(); }, 30000);
    }

    // weekend counter (kept)
    const countdownEl = document.getElementById('resetCountdown');
    const resetTitleEl = document.getElementById('resetTitle');
    const resetSubEl = document.getElementById('resetSub');
    const resetBox = document.getElementById('resetBox');

    function getWeekendWindow(refDate = new Date()){
      const now = new Date(refDate.getFullYear(), refDate.getMonth(), refDate.getDate(), refDate.getHours(), refDate.getMinutes(), refDate.getSeconds(), refDate.getMilliseconds());
      const day = now.getDay();
      const diffToSat = (6 - day + 7) % 7;
      const saturday = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diffToSat, 0, 0, 0, 0);
      const sundayEnd = new Date(saturday.getFullYear(), saturday.getMonth(), saturday.getDate() + 1, 18, 0, 0, 0);
      return { start: saturday, end: sundayEnd };
    }
    function formatTimeLeft(ms){
      if(ms <= 0) return "00:00:00";
      const totalSeconds = Math.floor(ms / 1000);
      const hrs = Math.floor(totalSeconds / 3600);
      const mins = Math.floor((totalSeconds % 3600) / 60);
      const secs = totalSeconds % 60;
      return [hrs, mins, secs].map(n => String(n).padStart(2,'0')).join(':');
    }
    let countdownTarget = null;
    function updateWeekendVisibilityAndTarget(){
      const now = new Date();
      const { start, end } = getWeekendWindow(now);
      if (now >= start && now <= end){
        countdownTarget = end;
        resetBox.classList.remove('hidden');
        resetTitleEl.textContent = "Fim do fim de semana — reabertura às 18:00 de domingo";
        resetSubEl.textContent = "Tempo restante até o fim do fim de semana";
      } else {
        countdownTarget = null;
        resetBox.classList.add('hidden');
      }
    }
    function tickWeekendCountdown(){
      const now = new Date();
      if(!countdownTarget){ updateWeekendVisibilityAndTarget(); countdownEl.textContent = "--:--:--"; return; }
      const diff = countdownTarget - now;
      if (diff <= 0){
        resetBox.classList.add('hidden');
        countdownTarget = null;
        buildCards();
        renderRemaining();
        renderAgenda();
        countdownEl.textContent = "00:00:00";
        return;
      }
      countdownEl.textContent = formatTimeLeft(diff);
    }

    init();
    updateWeekendVisibilityAndTarget();
    tickWeekendCountdown();
    setInterval(() => { updateWeekendVisibilityAndTarget(); tickWeekendCountdown(); }, 1000);

    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ updateWeekendVisibilityAndTarget(); tickWeekendCountdown(); } });

    let lastDateCheck = (new Date()).getDate();
    setInterval(() => {
      const now = new Date();
      const today = now.getDate();
      if (today !== lastDateCheck){
        lastDateCheck = today;
        buildCards();
        renderRemaining();
        renderAgenda();
      } else {
        document.querySelectorAll('.horarios.open').forEach(hEl => {
          const id = hEl.id.replace('horarios-','');
          const sel = document.getElementById(`turno-${id}`);
          if (sel && (sel.value === "Manhã" || sel.value === "Tarde" || sel.value === "Noite")) {
            const turno = sel.value;
            const selectedDay = getSelectedDayForCard(id);
            const frag = populateHorariosFragment(turno, selectedDay, id);
            hEl.innerHTML = "";
            hEl.appendChild(frag);
            requestAnimationFrame(()=> hEl.classList.add('open'));
            limitarSelecao(id);
          }
        });
      }
    }, 60 * 1000);

    window.addEventListener("focus", async ()=>{ 
      dados = loadData(); 
      renderRemaining(); 
      renderAgenda(); 
      await buildCards();
    });

  </script>
</body>
</html>