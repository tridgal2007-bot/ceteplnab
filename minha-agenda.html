<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meus Agendamentos</title>
  <style>
    /* Fonte Jersey 15 - coloque o arquivo Jersey.woff2 em ./fonts/ ou ajuste o caminho */
    @font-face {
      font-family: 'Jersey';
      src: url('./fonts/Jersey.woff2') format('woff2');
      font-weight: 100 900;
      font-style: normal;
      font-display: swap;
    }

    :root{
      --bg-1: #eef2ff;
      --bg-2: #f8fafc;
      --primary: #2563eb;
      --primary-700: #1e40af;
      --muted: #6b7280;
      --card-shadow: 0 8px 30px rgba(16,24,40,0.08);
      --radius: 14px;
      --ui-font-size: 15px; /* Jersey 15 */
      --max-w: 1024px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: 'Jersey', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
      font-size:var(--ui-font-size);
      background: radial-gradient(1200px 600px at 10% 10%, rgba(37,99,235,0.06), transparent 12%), linear-gradient(180deg,var(--bg-1),var(--bg-2));
      color:#0f1724;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      justify-content:center;
      padding:28px 16px;
    }

    .stage{ width:100%; max-width:var(--max-w); }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:18px 20px;
      border-radius:calc(var(--radius) + 4px);
      background: linear-gradient(90deg,var(--primary),var(--primary-700));
      color:#fff;
      box-shadow:0 10px 30px rgba(30,64,175,0.12);
    }
    header .title{display:flex;align-items:center;gap:12px}
    header h1{margin:0;font-size:1.05rem;font-weight:800}

    main{margin-top:18px}

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.55));
      backdrop-filter: blur(6px) saturate(120%);
      -webkit-backdrop-filter: blur(6px) saturate(120%);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:var(--card-shadow);
      border:1px solid rgba(16,24,40,0.04);
    }

    #agendaContainer{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:14px;
    }

    @media (max-width:720px){
      #agendaContainer{grid-template-columns: 1fr}
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,252,0.98));
      padding:12px 14px;
      border-radius:12px;
      box-shadow:0 6px 20px rgba(16,24,40,0.06);
      transition: transform .18s ease, box-shadow .18s ease;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:96px;
      border:1px solid rgba(16,24,40,0.03);
    }
    .card:hover{transform:translateY(-6px);box-shadow:0 16px 40px rgba(16,24,40,0.09)}

    .card-head{display:flex;align-items:center;gap:10px}
    .icon-wrap{width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg,rgba(37,99,235,0.12),rgba(29,78,216,0.06));display:flex;align-items:center;justify-content:center}
    .lab-name{font-weight:800;color:var(--primary);font-size:0.98rem}

    .meta-row{display:flex;gap:12px;flex-wrap:wrap;color:var(--muted);font-size:0.95rem}
    .pill{background:rgba(37,99,235,0.08);color:var(--primary);padding:6px 10px;border-radius:999px;font-weight:700;font-size:0.88rem}

    .email{margin-top:auto;font-size:0.86rem;color:var(--muted);word-break:break-all}

    .empty{grid-column:1/-1;text-align:center;color:var(--muted);padding:26px 10px;font-weight:600}

    .logout-btn{
      background:transparent;border:2px solid rgba(37,99,235,0.12);color:var(--primary);padding:8px 14px;border-radius:10px;font-weight:800;cursor:pointer;transition:all .12s ease}
    .logout-btn:hover{background:rgba(37,99,235,0.06);transform:translateY(-3px)}

    .hint{margin-top:10px;color:var(--muted);font-size:0.85rem;text-align:center}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="stage">
    <header>
      <div class="title">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden>
          <path d="M8 7V3m8 4V3M4 11h16M5 21h14a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <h1>Meus Agendamentos</h1>
      </div>
      <div style="display:flex;align-items:center;gap:12px">
        <div style="font-weight:700;font-size:0.9rem;opacity:0.95">Bem-vindo</div>
        <button class="logout-btn" onclick="logout()">Sair</button>
      </div>
    </header>

    <main style="margin-top:16px">
      <section class="panel" aria-labelledby="agenda-title">
        <div id="agenda-title" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden">Lista de agendamentos</div>

        <div id="agendaContainer" aria-live="polite">
          <p class="empty">Carregando seus agendamentos...</p>
        </div>

        <div class="hint">Agendamentos carregados a partir da sua conta. Use Sair para encerrar sess√£o.</div>
      </section>
    </main>
  </div>

  <script>
    const supabaseUrl = 'https://zszcwubydhgoyhxbxfro.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzemN3dWJ5ZGhnb3loeGJ4ZnJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MDk5MDMsImV4cCI6MjA3NTM4NTkwM30.ryioOoPAZnZzGdcTxIjfUcSlYUUqa7arA4qlUukyV7M';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

    const userEmail = localStorage.getItem("userEmail");
    const container = document.getElementById("agendaContainer");

    function escapeHtml(text){
      if (text === null || text === undefined) return '';
      return String(text).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;");
    }

    // formata dia (assume formato YYYY-MM-DD ou j√° uma string leg√≠vel)
    function formatDia(raw){
      if (!raw) return '‚Äî';
      const iso = /^\d{4}-\d{2}-\d{2}$/;
      if (iso.test(raw)){
        try{
          const d = new Date(raw + 'T00:00:00');
          return d.toLocaleDateString('pt-BR', { weekday: 'short', day:'2-digit', month:'short' });
        }catch(e){return raw}
      }
      return raw;
    }

    async function carregarAgendamentos(){
      if (!userEmail){
        container.innerHTML = `<p class="empty">‚ùå Nenhum usu√°rio logado. Fa√ßa login novamente.</p>`;
        return;
      }

      const { data, error } = await supabase
        .from('agendamentos')
        .select('*')
        .eq('user_email', userEmail)
        .order('dia', { ascending: true });

      if (error){
        console.error(error);
        container.innerHTML = `<p class="empty">Erro ao carregar agendamentos.</p>`;
        return;
      }

      if (!data || data.length === 0){
        container.innerHTML = `<p class="empty">üì≠ Voc√™ ainda n√£o possui agendamentos.</p>`;
        return;
      }

      container.innerHTML = data.map(item => {
        const lab = escapeHtml(item.lab_nome || 'Laborat√≥rio');
        const dia = escapeHtml(formatDia(item.dia));
        const horario = escapeHtml(item.horario || '‚Äî');
        const email = escapeHtml(item.user_email || '‚Äî');

        return `
          <article class="card" aria-label="Agendamento de ${lab}">
            <div class="card-head">
              <div class="icon-wrap" aria-hidden>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 7V3m8 4V3M4 11h16M5 21h14a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </div>
              <div>
                <div class="lab-name">${lab}</div>
                <div class="meta-row"><span class="pill">${dia}</span><span>${horario}</span></div>
              </div>
            </div>
            <div class="email">${email}</div>
          </article>
        `;
      }).join('');
    }

    function logout(){
      localStorage.clear();
      window.location.href = 'index.html';
    }

    carregarAgendamentos();
  </script>
</body>
</html>
